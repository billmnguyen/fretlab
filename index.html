<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Red Guitar Emoji Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé∏</text></svg>">
  <title>üé∏ FretLab - Ultimate Sync Mode</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load jsmediatags for local file metadata (artwork/title) extraction -->
  <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
  
  <style>
    /* --- CSS: FretLab Clean Modern Theme (Futura ExtraBold) --- */
    
    :root {
      --background-dark: #101010;
      --text-light: #FFFFFF;
      --accent-cyan: #00FFFF;
      --active-bg: rgba(0, 255, 255, 0.15);
      
      /* Font settings for Futura ExtraBold effect */
      --main-font: 'Futura', 'Century Gothic', 'Inter', sans-serif;
    }

    body {
      background: var(--background-dark);
      color: var(--text-light);
      font-family: var(--main-font);
      font-weight: 900;
      min-height: 100vh;
      line-height: 1.4;
    }

    /* Apply the font style to ALL elements */
    * {
        font-family: var(--main-font) !important;
        font-weight: 900 !important;
    }

    /* Scrollbar (Clean Cyan) */
    .lyrics::-webkit-scrollbar { width: 6px; }
    .lyrics::-webkit-scrollbar-track { background: #202020; border-radius: 3px; }
    .lyrics::-webkit-scrollbar-thumb { background: var(--accent-cyan); border-radius: 3px; }

    /* Chord Styling */
    .chord {
      color: var(--accent-cyan);
      font-weight: 900;
      margin-right: 16px;
      display: inline-block;
      min-width: 70px;
      font-size: 1.1em;
      text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
    }

    /* Lyric Line Styling */
    .lyric-line {
      margin-bottom: 18px;
      padding: 12px;
      border-radius: 8px;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.6);
    }

    /* Active State (Sync Highlight) */
    .active {
      background: var(--active-bg); 
      border-left: 3px solid var(--accent-cyan);
      padding-left: 18px;
      color: var(--text-light);
      transform: scale(1.005);
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
    }

    /* UI elements */
    .control-btn, .action-label {
        background-color: #333333;
        border: 1px solid #444444;
        transition: background-color 0.15s;
    }
    .control-btn:hover:not(:disabled), .action-label:hover {
        background-color: #444444;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.5); 
    }
    .song-info {
        background-color: #1a1a1a;
        border: 1px solid #333333;
    }
    .lyrics-card {
        background-color: #1a1a1a;
        border: 1px solid #333333;
    }
  </style>
</head>

<body class="flex justify-center items-start p-6 sm:p-8">

  <div class="container max-w-xl w-full flex flex-col items-center space-y-6">

    <!-- Header -->
    <h1 class="text-4xl sm:text-5xl text-white mt-4 tracking-wider">FRET-LAB üé∏</h1>
    <p class="text-lg text-gray-400 mb-6">ULTIMATE SYNC MODE</p>

    <!-- Audio Element (Used by JS) -->
    <audio id="player" style="display:none;"></audio>

    <!-- Song Info Card (Defaulted to Self Control) -->
    <div id="songInfoCard" class="song-info flex w-full p-4 rounded-xl shadow-lg">
      <div id="coverArtContainer" class="album-cover w-24 h-24 mr-4 rounded-md overflow-hidden flex-shrink-0 border-2 border-cyan-500">
        <!-- Placeholder image for Self Control (Blonde album) -->
        <img id="albumArt" src="https://upload.wikimedia.org/wikipedia/en/a/a0/Blonde_-_Frank_Ocean.jpeg" alt="Album Cover" class="w-full h-full object-cover">
      </div>
      <div class="song-details flex flex-col justify-center w-full">
        <h2 id="songTitle" class="text-2xl text-white mb-1">SELF CONTROL</h2>
        <p id="songArtist" class="text-md text-cyan-400 mb-3">FRANK OCEAN</p>
        
        <!-- File Loader -->
        <div class="flex space-x-2 mt-2">
            <label class="action-label cursor-pointer w-1/2 text-white py-2 px-1 rounded transition text-sm text-center">
              üìÇ LOAD LOCAL MP3
              <input type="file" id="audioFile" accept="audio/mp3, audio/wav, audio/flac, audio/ogg" class="hidden">
            </label>
            <button id="youtubeLoadBtn" class="action-label w-1/2 text-white py-2 px-1 rounded transition text-sm text-center">
              ‚ñ∂Ô∏è YOUTUBE (SIMULATOR)
            </button>
        </div>
        <p id="fileNameDisplay" class="text-xs text-gray-500 mt-1 italic">Load a file or simulate YouTube lyrics.</p>
      </div>
    </div>

    <!-- Playback Controls -->
    <div class="controls flex space-x-4">
      <button id="play" class="control-btn px-8 py-3 text-white rounded-full transition duration-300 disabled:opacity-30 disabled:cursor-not-allowed text-lg" disabled>‚ñ∂Ô∏è PLAY</button>
      <button id="stop" class="control-btn px-8 py-3 text-white rounded-full transition duration-300 disabled:opacity-30 disabled:cursor-not-allowed text-lg" disabled>‚èπÔ∏è STOP</button>
    </div>

    <!-- Lyrics & Chords Display -->
    <div class="lyrics-card w-full p-6 rounded-xl shadow-xl">
      <div class="lyrics h-96 overflow-y-auto" id="lyrics">
        <!-- Content populated by JS -->
      </div>
    </div>

    <!-- YouTube Input Modal (Simulated) -->
    <div id="youtubeModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center p-4">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md space-y-4 border border-cyan-500">
            <h3 class="text-xl text-white mb-1">YOUTUBE SIMULATION</h3>
            <p class="text-sm text-yellow-400">üö® TECHNICAL LIMITATION</p>
            <p class="text-sm text-gray-400">Direct YouTube audio access and conversion is blocked by browser security. Select a song below to simulate loading the correct lyrics and chords.</p>
            
            <div class="flex flex-col space-y-2 pt-2">
                <button data-song="STAIRWAY TO HEAVEN" class="load-youtube-song-btn control-btn bg-cyan-700 hover:bg-cyan-600 px-4 py-3 rounded text-sm">SIMULATE: Led Zeppelin - Stairway to Heaven</button>
                <button data-song="SELF CONTROL" class="load-youtube-song-btn control-btn bg-cyan-700 hover:bg-cyan-600 px-4 py-3 rounded text-sm">SIMULATE: Frank Ocean - Self Control</button>
                <button data-song="WONDERWALL" class="load-youtube-song-btn control-btn bg-cyan-700 hover:bg-cyan-600 px-4 py-3 rounded text-sm">SIMULATE: Oasis - Wonderwall</button>
            </div>
            
            <div class="flex justify-end pt-3">
                <button id="closeModalBtn" class="control-btn px-4 py-2 rounded text-sm">CLOSE</button>
            </div>
        </div>
    </div>

  </div>

  <script>
    // --- JAVASCRIPT: Logic and Data ---
    const audioFileInput = document.getElementById("audioFile");
    const fileNameDisplay = document.getElementById("fileNameDisplay");
    const playBtn = document.getElementById("play");
    const stopBtn = document.getElementById("stop");
    const lyricsContainer = document.getElementById("lyrics");
    const audioPlayer = document.getElementById("player");
    const songTitleElement = document.getElementById("songTitle");
    const songArtistElement = document.getElementById("songArtist");
    const albumArtElement = document.getElementById("albumArt");
    const youtubeLoadBtn = document.getElementById("youtubeLoadBtn");
    const youtubeModal = document.getElementById("youtubeModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const loadYoutubeSongBtns = document.querySelectorAll(".load-youtube-song-btn");


    let currentSongData = null;
    let animationFrame;

    // --- SONG DATA DATABASE (With more accurate lyrics and timings) ---
    const songDatabase = {
      // LED ZEPPELIN - STAIRWAY TO HEAVEN
      "STAIRWAY TO HEAVEN": {
        artist: "LED ZEPPELIN",
        defaultImage: "https://placehold.co/100x100/A00000/FFFFFF?text=LZ",
        lyrics: [ 
            {time: 0.0, chord:'Am', lyric:'(Intro Arpeggios)'},
            {time: 8.0, chord:'G/B', lyric:'There\'s a lady who\'s sure all that glitters is gold'},
            {time: 15.0, chord:'C', lyric:'And she\'s buying a stairway to heaven.'},
            {time: 21.0, chord:'Fmaj7', lyric:'When she gets there she knows, if the stores are all closed'},
            {time: 28.0, chord:'Am', lyric:'With a word she can get what she came for.'},
            {time: 35.0, chord:'G/B', lyric:'Ooh, ooh, and she\'s buying a stairway to heaven.'},
            {time: 43.0, chord:'C', lyric:'There\'s a sign on the wall but she wants to be sure'},
            {time: 50.0, chord:'Fmaj7', lyric:'\'Cause you know sometimes words have two meanings.'},
            {time: 57.0, chord:'Am', lyric:'In a tree by the brook, there\'s a songbird who sings,'},
            {time: 64.0, chord:'G/B', lyric:'Sometimes all of our thoughts are misgiven.'},
            {time: 72.0, chord:'C', lyric:'Ooh, it makes me wonder,'},
            {time: 75.0, chord:'Fmaj7', lyric:'Ooh, it makes me wonder.'},
            {time: 80.0, chord:'N.C.', lyric:'(Sample lyrics end here for brevity)'},
        ]
      },
      // FRANK OCEAN - SELF CONTROL
      "SELF CONTROL": {
        artist: "FRANK OCEAN",
        defaultImage: "https://upload.wikimedia.org/wikipedia/en/a/a0/Blonde_-_Frank_Ocean.jpeg",
        lyrics: [ 
            {time: 0.0, chord:'N.C.', lyric:'(Ambiance)'},
            {time: 1.0, chord:'N.C.', lyric:'Poolside convo about your summer last night, oh yeah'},
            {time: 3.8, chord:'N.C.', lyric:'About your summer last night'},
            {time: 6.0, chord:'N.C.', lyric:'Ain\'t give you no play, mm'},
            {time: 8.8, chord:'Am', lyric:'Could I make it shine last night?'},
            {time: 11.5, chord:'G', lyric:'Could I make it shine on it last night, last night?'},
            {time: 14.8, chord:'C', lyric:'Could we make it in? Do we have time?'},
            {time: 18.0, chord:'F', lyric:'I\'ll be the boyfriend in your wet dreams tonight'},
            {time: 21.5, chord:'Am', lyric:'Noses on a rail, little virgin wears the white'},
            {time: 24.8, chord:'G', lyric:'You cut your hair but you used to live a blonded life'},
            {time: 28.3, chord:'C', lyric:'Wish I was there, wish we had grown up on the same advice'},
            {time: 31.8, chord:'F', lyric:'And our time was right'},
            {time: 34.0, chord:'Am', lyric:'Keep a place for me, for me'},
            {time: 37.0, chord:'G', lyric:'I\'ll sleep between y\'all, it\'s nothing'},
            {time: 39.5, chord:'C', lyric:'It\'s no thing, it\'s nothing'},
            {time: 43.0, chord:'F', lyric:'Keep a place for me, for me'},
            {time: 46.0, chord:'Am', lyric:'(Sample lyrics end here for brevity)'},
        ]
      },
      
      // OASIS - WONDERWALL
      "WONDERWALL": {
        artist: "OASIS",
        defaultImage: "https://placehold.co/100x100/333333/00FFFF?text=W.",
        lyrics: [
            {time: 0.0, chord:'N.C.', lyric:'(Intro drums)'},
            {time: 6.0, chord:'Em7', lyric:'Today is gonna be the day'},
            {time: 8.5, chord:'G', lyric:'That they\'re gonna throw it back to you'},
            {time: 11.0, chord:'Dsus4', lyric:'By now you should\'ve somehow'},
            {time: 13.5, chord:'A7sus4', lyric:'Realized what you gotta do'},
            {time: 17.0, chord:'Em7', lyric:'I don\'t believe that anybody'},
            {time: 19.5, chord:'G', lyric:'Feels the way I do about you now'},
            {time: 23.0, chord:'Dsus4', lyric:'Backbeat the word is on the street'},
            {time: 25.5, chord:'A7sus4', lyric:'That the fire in your heart is out'},
            {time: 29.0, chord:'F', lyric:'I\'m sure you\'ve heard it all before'},
            {time: 33.0, chord:'C', lyric:'But you never really had a doubt'},
            {time: 36.0, chord:'G', lyric:'I don\'t believe that anybody'},
            {time: 40.0, chord:'F', lyric:'Feels the way I do about you now'},
            {time: 44.0, chord:'C', lyric:'And all the roads we have to walk are winding'},
            {time: 48.0, chord:'G', lyric:'And all the lights that lead us there are blinding'},
            {time: 51.0, chord:'Am', lyric:'There are many things that I'},
            {time: 54.0, chord:'G', lyric:'Would like to say to you, but I don\'t know how'},
            {time: 57.0, chord:'C', lyric:'Because maybe...'},
            {time: 59.0, chord:'G', lyric:'You\'re gonna be the one that saves me'},
            {time: 62.0, chord:'Am', lyric:'And after all...'},
            {time: 64.0, chord:'Em', lyric:'You\'re my wonderwall'},
            {time: 67.0, chord:'C', lyric:'(Sample lyrics end here for brevity)'},
        ]
      }
    };
    
    // --- UTILITY FUNCTIONS ---

    function formatTitle(filename) {
        let title = filename.replace(/\.[^/.]+$/, ""); 
        title = title.replace(/[-_]/g, ' ').toUpperCase().trim();
        return title.length > 0 ? title : "UNKNOWN SONG";
    }

    function getSongKeyByFilename(filename) {
        const title = formatTitle(filename);
        if (title.includes("STAIRWAY")) return "STAIRWAY TO HEAVEN";
        if (title.includes("CONTROL")) return "SELF CONTROL";
        if (title.includes("WONDERWALL")) return "WONDERWALL";
        return "SELF CONTROL"; // Default to Self Control
    }
    
    function resetPlayerState() {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        playBtn.textContent = "‚ñ∂Ô∏è PLAY";
        cancelAnimationFrame(animationFrame);
        Array.from(lyricsContainer.children).forEach(l => l.classList.remove('active'));
        lyricsContainer.scrollTop = 0;
    }

    // --- UI/DATA HANDLING FUNCTIONS ---

    function updateUI(songKey, localFile) {
        const data = songDatabase[songKey];
        if (!data) return;

        currentSongData = data.lyrics;

        if (localFile) {
            // Set fallback title/artist based on filename formatting
            songTitleElement.textContent = formatTitle(localFile.name);
            songArtistElement.textContent = 'LOCAL FILE';
            albumArtElement.src = data.defaultImage; // Use DB image as temporary fallback until tags are read
            
            fileNameDisplay.textContent = `LOADED: ${localFile.name.toUpperCase()}`;
            fileNameDisplay.style.color = "var(--accent-cyan)";
            extractMetadata(localFile); // This will attempt to override the fallback
            playBtn.disabled = false;
        } else {
            // Default/YouTube Simulation setting (use DB data)
            songTitleElement.textContent = songKey;
            songArtistElement.textContent = data.artist;
            albumArtElement.src = data.defaultImage; 
            
            fileNameDisplay.textContent = "NOTE: Lyrics loaded. Load local file for playback.";
            fileNameDisplay.style.color = "yellow";
            playBtn.disabled = true;
        }
        
        renderLyrics();
        stopBtn.disabled = false;
    }

    function renderLyrics() {
        lyricsContainer.innerHTML = '';
        currentSongData.forEach((line) => {
            const div = document.createElement('div');
            div.classList.add('lyric-line');
            div.innerHTML = `<span class="chord">${line.chord}</span>${line.lyric}`;
            lyricsContainer.appendChild(div);
        });
    }

    // --- METADATA EXTRACTION (jsmediatags) ---
    function extractMetadata(file) {
        try {
             jsmediatags.read(file, {
                onSuccess: function(tag) {
                    const songKey = getSongKeyByFilename(file.name);
                    
                    // 1. Title and Artist extraction
                    if (tag.tags.title) {
                        songTitleElement.textContent = tag.tags.title.toUpperCase();
                    }
                    if (tag.tags.artist) {
                        songArtistElement.textContent = tag.tags.artist.toUpperCase();
                    }
                    
                    // 2. Artwork extraction
                    if (tag.tags.picture) {
                        const picture = tag.tags.picture;
                        const base64String = arrayBufferToBase64(picture.data);
                        albumArtElement.src = `data:${picture.format};base64,${base64String}`;
                    } else {
                        // If no artwork in tags, reset to the DB default for the recognized song
                        albumArtElement.src = songDatabase[songKey].defaultImage;
                    }
                },
                onError: function(error) {
                    // console.log("Error reading tags:", error.type);
                    // If tags fail, title/artist/artwork remains the fallback set in updateUI.
                }
            });
        } catch(e) {
            // console.error("jsmediatags failed:", e);
        }
    }
    
    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    // --- SYNC CORE LOGIC ---

    function updateSync(currentTime) {
        const lines = lyricsContainer.children;
        
        for(let idx = 0; idx < currentSongData.length; idx++) {
            const line = currentSongData[idx];
            const div = lines[idx];
            const nextTime = currentSongData[idx + 1]?.time || Infinity;

            if (currentTime >= line.time && currentTime < nextTime) {
                if (!div.classList.contains('active')) {
                    Array.from(lines).forEach(l => l.classList.remove('active'));
                    div.classList.add('active');
                    div.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                break; 
            }
        }
    }

    function syncLoop() {
        if (!audioPlayer.paused) {
            updateSync(audioPlayer.currentTime);
            animationFrame = requestAnimationFrame(syncLoop);
        }
    }

    // --- EVENT LISTENERS ---

    // 1. Local File Load
    audioFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            resetPlayerState();
            const fileUrl = URL.createObjectURL(file);
            audioPlayer.src = fileUrl;
            
            // Get the song key based on the filename (for fetching synchronized lyrics)
            const songKey = getSongKeyByFilename(file.name);
            updateUI(songKey, file); // Load lyrics and set filename as fallback title/artist
        }
    });

    // 2. YouTube Modal Control
    youtubeLoadBtn.addEventListener('click', () => {
        youtubeModal.classList.remove('hidden');
    });

    closeModalBtn.addEventListener('click', () => {
        youtubeModal.classList.add('hidden');
    });

    // Handle song selection from the simulated YouTube modal
    loadYoutubeSongBtns.forEach(button => {
        button.addEventListener('click', (event) => {
            const songKey = event.target.getAttribute('data-song');
            youtubeModal.classList.add('hidden');
            
            // Clear any local file in the player
            audioPlayer.src = '';
            
            resetPlayerState();
            updateUI(songKey, null); // Load static lyrics for simulation
        });
    });


    // 3. Playback Controls
    playBtn.addEventListener('click', () => {
        if (!audioPlayer.src) {
            fileNameDisplay.textContent = "‚ùó ERROR: NO VALID AUDIO SOURCE LOADED ‚ùó";
            fileNameDisplay.style.color = "#FF0000";
            return;
        }

        if (audioPlayer.paused) {
            audioPlayer.play().then(() => {
                playBtn.textContent = "‚è∏Ô∏è PAUSE";
                syncLoop();
            }).catch(err => {
                console.error("Playback Error:", err);
                fileNameDisplay.textContent = "PLAYBACK FAILED. BROWSER BLOCKED AUTOPLAY OR FILE IS CORRUPT.";
                fileNameDisplay.style.color = "#FF0000";
            });
        } else {
            audioPlayer.pause();
            playBtn.textContent = "‚ñ∂Ô∏è PLAY";
            cancelAnimationFrame(animationFrame);
        }
    });

    stopBtn.addEventListener('click', () => {
        resetPlayerState();
    });

    audioPlayer.addEventListener('ended', () => {
        stopBtn.click();
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', init);
    function init() {
        // Load default song data (Self Control)
        updateUI("SELF CONTROL", null); 
    }

  </script>
</body>
</html>
